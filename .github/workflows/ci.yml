name: Vision Platform CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Install deps (root + packages)
        run: |
          npm ci
          cd packages/shared && npm ci || true
          cd ../../apps/web && npm ci || true
          cd ../../backend && npm ci || true
      - name: Run tests
        run: |
          npm test --workspaces || true
          cd backend && npm run test || true
      - name: Build (if present)
        run: |
          npm run build || true
          cd apps/web && npm run build || true

  backend-smoke:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password123
          MONGO_INITDB_DATABASE: vision_platform
        ports:
          - 27017:27017
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install backend deps
        run: |
          cd backend
          npm ci
      - name: Run simple integration tests
        run: |
          cd backend
          npm run test:integration || npm test
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://admin:password123@localhost:27017/vision_platform?authSource=admin
          REDIS_URL: redis://localhost:6379
